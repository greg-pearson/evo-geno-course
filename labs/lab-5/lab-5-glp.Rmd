---
output: html_document
---

# Data Wrangling and Graphing COVID-19 Reporting Data (Part 1)

```{r}
library(tidyverse)

# Read csv file into R
report_03_11_2020 <-   read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-11-2020.csv")) %>%
  rename(Country_Region = "Country/Region", Province_State = "Province/State")

```

```{r}

# Check table properties
str(report_03_11_2020)

```

```{r}

# Inspect the data frame
head(report_03_11_2020)

```

### Interactive Data Tables

You can make an interactive data table with the [DT package](https://rstudio.github.io/DT/).

```{r}

# Make an interactive data table with the DT package
library(DT)
datatable(report_03_11_2020)

```

## Exercise Challenges (Part 1)

Use the DT package for showing the data tables where appropriate.

  1. The format of the daily reports has changed over time. What are the differences between 3/12/2020, the Friday before spring break 2020 and yesterday 6 months later on 9/12/2020? Load the files into R and use str() and View() (or in the top right corner click on Environment and then the data frame.). Note the in the more recent dates they have changed the column headers so that it is no longer necessary to rename Province_State and Country_Region.

  2. Many countries have multiple entries representing different regions (e.g. counties and states). To get the counts for a country we need to summarise the data. Use group_by() and summarize() to make a data frame (tibble) with total counts for each country.

  3. To get counts for confirmed cases per U.S state use filter() to select US and group_by and summarize as above.

  4. It will be difficult to make simple graphs with the data from all countries in the world or even the US states. Use arrange_by() and slice() to get just the top 10 countries for Deaths.

### Exercise (Part 1) - Challenge 1

The format of the daily reports has changed over time. What are the differences between 3/12/2020, the Friday before spring break 2020 and yesterday 6 months later on 9/12/2020? Load the files into R and use str() and View() (or in the top right corner click on Environment and then the data frame.). Note the in the more recent dates they have changed the column headers so that it is no longer necessary to rename Province_State and Country_Region.

```{r}

library(tidyverse)

# Read csv file into R
report_03_12_2020 <-   read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-12-2020.csv")) %>%
  rename(Country_Region = "Country/Region", Province_State = "Province/State")

report_09_12_2020 <-   read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/09-12-2020.csv"))

```

```{r}

str(report_03_12_2020)

```

```{r}

str(report_09_12_2020)

```

**There are far fewer countries/provinces/states in the March compared to September dataframe, indicating that SARS-CoV-2 spread and/or testing became more available worldwide over the 6 month period.**

### Exercises (Part 1) - Challenge 2

Many countries have multiple entries representing different regions (e.g. counties and states). To get the counts for a country we need to summarise the data. Use group_by() and summarize() to make a data frame (tibble) with total counts for each country.

```{r}

library(tidyverse)

sum <- report_03_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_confirmed_cases=sum(Confirmed),
            total_deaths=sum(Deaths))

library(DT)
datatable(sum)

```

```{r}

library(tidyverse)

sum <- report_09_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_confirmed_cases=sum(Confirmed),
            total_deaths=sum(Deaths))

library(DT)
datatable(sum)

```

### Exercises (Part 1) - Challenge 3

To get counts for confirmed cases per U.S state use filter() to select US and group_by and summarize as above.

```{r}

library(tidyverse)

sum <- report_03_12_2020 %>%
  filter(Country_Region=="US") %>%
  group_by(Province_State) %>%
  summarize(total_confirmed_cases=sum(Confirmed),
            total_deaths=sum(Deaths))

library(DT)
datatable(sum)

```

```{r}

library(tidyverse)

sum <- report_09_12_2020 %>%
  filter(Country_Region=="US") %>%
  group_by(Province_State) %>%
  summarize(total_confirmed_cases=sum(Confirmed),
            total_deaths=sum(Deaths))

library(DT)
datatable(sum)

```

### Exercises (Part 1) - Challenge 4

It will be difficult to make simple graphs with the data from all countries in the world or even the US states. Use arrange_by() and slice() to get just the top 10 countries for Deaths.

```{r}

library(tidyverse)

sum <- report_03_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(DT)
datatable(sum)

```

```{r}

library(tidyverse)

sum <- report_09_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(DT)
datatable(sum)

```

## Exercises Challenges (Part 2)

1. Make plots using geom_point() of the 10 countries with the confirmed cases and deaths (two separate graphs) on 3/12/2020 and 9/12/2020.

2. Make using geom_bar of the 10 states with the most confirmed cases and deaths (two separate graphs) on 3/12/2020 and 9/12/2020.

### Exercises (Part 2) - Challenge 1

Make plots using geom_point() of the 10 countries with the confirmed cases and deaths (two separate graphs) on 3/12/2020 and 9/12/2020.

```{r}

library(tidyverse)

sum <- report_03_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(ggplot2)
ggplot(sum, aes(x=Country_Region, y=total_deaths)) +
  geom_point() +
  labs(x="Country", y="Deaths (03/12/2020)") +
  theme_classic()

```

```{r}

library(tidyverse)

sum <- report_09_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(ggplot2)
ggplot(sum, aes(x=Country_Region, y=total_deaths)) +
  geom_point() +
  labs(x="Country", y="Deaths (09/12/2020)") +
  theme_classic()

```

### Exercises (Part 1) - Challenge 2

Make using geom_bar of the 10 states with the most confirmed cases and deaths (two separate graphs) on 3/12/2020 and 9/12/2020.

```{r}

library(tidyverse)

sum <- report_03_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(ggplot2)
ggplot(sum, aes(x=Country_Region, y=total_deaths)) +
  geom_bar(stat="identity") +
  labs(x="Country", y="Deaths (03/12/2020)") +
  theme_classic()

```

```{r}

library(tidyverse)

sum <- report_09_12_2020 %>%
  group_by(Country_Region)%>%
  summarize(total_deaths=sum(Deaths)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

library(ggplot2)
ggplot(sum, aes(x=Country_Region, y=total_deaths)) +
  geom_bar(stat="identity") +
  labs(x="Country", y="Deaths (09/12/2020)") +
  theme_classic()

```

# Data Wrangling and Graphing COVID-19 Reporting Data (Part 2)

```{r}

library(tidyverse)

Confirmed_State_3_13 <-   read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-13-2020.csv")) %>%
  rename(Country_Region = "Country/Region", Province_State = "Province/State") %>% 
  filter (Country_Region == "US") %>% 
  group_by(Province_State, Country_Region) %>% 
  summarise(Confirmed = sum(Confirmed))

str(Confirmed_State_3_13)

```


```{r}

library(tidyverse)

Confirmed_State_9_13 <-   read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/09-13-2020.csv")) %>% 
  filter (Country_Region == "US") %>% 
  group_by(Province_State, Country_Region) %>% 
  summarise(Confirmed = sum(Confirmed)) 

str(Confirmed_State_9_13)

```

**Notice from the above `strâ€™ calls that there are 53 states in the table on 3/13/2020 and 58 states in the table on 9/13/2020**

```{r}

setdiff(Confirmed_State_9_13$Province_State, Confirmed_State_3_13$Province_State)

```

```{r}

Confirmed_State_9_13 <- Confirmed_State_9_13 %>% 
  filter(Province_State != "Recovered") 

```

```{r}

Confirmed_State_3_13_9_13_joined <- full_join(Confirmed_State_3_13, Confirmed_State_9_13, by = c("Province_State"))
head(Confirmed_State_3_13_9_13_joined)

```

```{r}

tail(Confirmed_State_3_13_9_13_joined, 5)

```

```{r}

which(is.na(Confirmed_State_3_13_9_13_joined))

```

```{r}

Confirmed_State_3_13_9_13_joined <- full_join(Confirmed_State_3_13, Confirmed_State_9_13, by = c("Province_State")) %>% 
      rename(Confirmed_3_13_2020 = "Confirmed.x", Confirmed_9_13_2020 = "Confirmed.y") %>% 
      select(-Country_Region.x, -Country_Region.y) %>% 
      replace_na(list(Confirmed_3_13_2020 = 0))
head(Confirmed_State_3_13_9_13_joined)

```

```{r}

which(is.na(Confirmed_State_3_13_9_13_joined))

```

### Switching between long and wide formats

```{r}

Confirmed_State_3_13_9_13_joined_long <- Confirmed_State_3_13_9_13_joined %>% 
              pivot_longer(-c(Province_State), names_to = "Date", values_to = "Confirmed")
head(Confirmed_State_3_13_9_13_joined_long)

```

```{r}

Confirmed_State_3_13_9_13_joined_long <- Confirmed_State_3_13_9_13_joined %>% 
              gather(key="Date", value="Confirmed", 2:length(.))
head(Confirmed_State_3_13_9_13_joined_long)

```

```{r fig.width=5, fig.height=10}

library(ggplot2)
ggplot(Confirmed_State_3_13_9_13_joined_long, aes(x = Confirmed,  y = Province_State))  + 
    geom_point(aes(color = Date))

```

### Working with Time Series Data

```{r}

library(tidyverse)

time_series_confirmed <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region")

head(time_series_confirmed)

```

```{r}

time_series_confirmed_long <- time_series_confirmed %>% 
               gather(key="Date", value="Confirmed", 5:length(.))

head(time_series_confirmed_long)
```

```{r}

library(tidyverse)

time_series_deaths <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region")

head(time_series_deaths)

```

```{r}

time_series_deaths_long <- time_series_deaths %>% 
               gather(key="Date", value="Deaths", 5:length(.))

head(time_series_deaths_long)
```

#### Joining the Time Series Tables

```{r}

time_series_confirmed_long <- time_series_confirmed_long %>% 
  unite(Key, Province_State, Country_Region, Date, sep = ".", remove = FALSE)
head(time_series_confirmed_long)

```

```{r}

time_series_deaths_long <- time_series_deaths_long %>% 
  unite(Key, Province_State, Country_Region, Date, sep = ".") %>% 
  select(Key, Deaths)

head(time_series_deaths_long)

```

```{r}

time_series_long_joined <- full_join(time_series_confirmed_long, time_series_deaths_long, by = c("Key")) %>% 
  select(-Key)
head(time_series_long_joined)

```

```{r}

which(is.na(time_series_long_joined$Confirmed))

```

```{r}

which(is.na(time_series_long_joined$Deaths))

```

```{r}

library(lubridate)
time_series_long_joined$Date <- lubridate::mdy(time_series_long_joined$Date)
head(time_series_long_joined)

```

```{r}

time_series_long_joined_counts <- time_series_long_joined %>% 
  gather(key="Report_Type", value="Counts", 6:length(.))

head(time_series_long_joined_counts)

```

### Making Graphs with Time Series Data



## Challenge Exercises

### Challenge Exercise 1

Revise the above example for joining tables using 6/13/2020 and 9/13/2020. Plot the data as a bar plot. Make sure your graph looks nice in the report by adjusting the height of the graph in the R code chunk header.

```{r}

library(tidyverse)

Confirmed_6_13 <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/06-13-2020.csv")) %>%
  select(3:4, 8) %>%
  mutate(Date = lubridate::mdy("06/13/2020")) %>%
  select(Date, everything())

head(Confirmed_6_13)

```

```{r}

library(tidyverse)

Confirmed_9_13 <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/09-13-2020.csv")) %>%
  select(3:4,8) %>%
  mutate(Date = lubridate::mdy("09/13/2020")) %>%
  select(Date, everything())


head(Confirmed_9_13)

```

```{r}

Confirmed_6_13_9_13 <- bind_rows(Confirmed_6_13, Confirmed_9_13) %>%
  gather(key="Report_Type", value="Count", 4:length(.)) %>%
  filter(Country_region)

```

### Challenge Exercise 2

Add more informative x and y labels and a title to the above graph in Ex1.

### Challenge Exercise 3

Using the time series data. Make a plot of the total number of confirmed deaths per day worldwide

```{r}

library(tidyverse)

time_series_deaths <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region") %>%
  gather(key="Date", value="Deaths", 5:length(.)) %>%
  mutate(Date = lubridate::mdy(Date))

head(time_series_deaths)

```

```{r}

time_series_deaths_per_date <- time_series_deaths %>%
  group_by(Date) %>%
  summarize(Deaths = sum(Deaths)) %>%
  mutate(Deaths_per_day = Deaths - lag(Deaths))

head(time_series_deaths_per_date)

```

```{r}

library(ggplot2)

ggplot(time_series_deaths_per_date, aes(x=Date, y=Deaths_per_day)) +
  geom_line() +
  labs(x="", y="Confirmed Deaths", title="Confirmed Deaths Per Day Worldwide") +
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5, face="bold"))
  
```


### Challenge Exercise 4

Use Mutate to make a new column with deaths/confirmed cases (Hint: this might be best done after joining the tables, but before pivoting longer).

```{r}

library(tidyverse)

time_series_confirmed <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region") %>%
  mutate(report_type = "confirmed_cases") %>%
  select(report_type, everything())

head(time_series_confirmed)

```

```{r}

library(tidyverse)

time_series_deaths <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region") %>%
  mutate(report_type = "confirmed_deaths") %>%
  select(report_type, everything())

head(time_series_deaths)

```

```{r}

library(tidyverse)

time_series_joined <- bind_rows(time_series_confirmed, time_series_deaths) %>%
  gather(key="date", value="count", 6:length(.)) %>%
  mutate(date=lubridate::mdy(date)) %>%
  spread(key="report_type", value="count") %>%
  mutate(confirmed_cases=replace_na(confirmed_cases, 0),
         confirmed_deaths=replace_na(confirmed_deaths, 0))

head(time_series_joined)
tail(time_series_joined)

```

```{r}

library(tidyverse)

time_series_sum <- time_series_joined %>%
  group_by(date) %>%
  summarize(cases = sum(confirmed_cases),
            deaths = sum(confirmed_deaths)) %>%
  mutate(deaths_cases = deaths/cases)

head(time_series_sum)

```


### Challenge Exercise 5

Plot US deaths/confirmed cases per day.

```{r}

library(tidyverse)

time_series_sum <- time_series_joined %>%
  filter(Country_Region=="US") %>%                      #| Filter only US Data
  group_by(date) %>%
  summarize(cases = sum(confirmed_cases),
            deaths = sum(confirmed_deaths)) %>%
  mutate(deaths_cases = deaths/cases)

```


```{r}

library(ggplot2)

ggplot(time_series_sum, aes(x=date, y=deaths_cases)) +
  geom_line() +
  labs(x="", y="Deaths/Cases", title="Fatality Rate in the U.S.") +
  theme_classic()

```

### Challenge Exercise 6

Make a single graph with from the times series data with the 10 countries with the hightest death total.

```{r}

library(tidyverse)

time_series_deaths <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region") %>%
  gather(key="date", value="count", 5:length(.)) %>%
  mutate(date = lubridate::mdy(date))

tail(time_series_deaths)

```

```{r}

library(tidyverse)

time_series_top_deaths <- time_series_deaths %>%
  filter(date=="2020-09-26") %>%
  group_by(Country_Region) %>%
  summarize(total_deaths = sum(count)) %>%
  arrange(desc(total_deaths)) %>%
  slice(1:10)

head(time_series_top_deaths)
  
```

```{r}

library(ggplot2)

ggplot(time_series_top_deaths, aes(x=Country_Region, y=total_deaths)) +
  geom_bar(stat="identity") +
  labs(x="", y="total deaths", title="Top 10 Countries: COVID-19 Deaths") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face="bold"))

```


### Challenge Exercise 7

Using Facet_Wraps make a graph from the times series data with the 10 countries with the hightest death total. Format the table to look nice in the report by changing the number of rows in your graph and/or adjusting the height in the R code chunk header.

```{r}

library(tidyverse)

time_series_deaths <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>%
  rename(Province_State = "Province/State", Country_Region = "Country/Region") %>%
  gather(key="date", value="count", 5:length(.)) %>%
  mutate(date = lubridate::mdy(date)) %>%
  filter(Country_Region %in% c("Brazil", "France", "India", "Iran", "Italy", "Mexico", "Peru", "Spain", "United Kingdom", "US")) %>%
  group_by(date, Country_Region) %>%
  summarize(total_deaths = sum(count))

head(time_series_deaths)

```

```{r}

library(ggplot2)

ggplot(time_series_deaths, aes(x=date, y=total_deaths)) +
  geom_line() +
  labs(x="", y="total deaths", title="Top 10 Countries: COVID-19 Deaths") +
  facet_wrap(~Country_Region, ncol=5) +
  theme_linedraw() +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

### Challenge Exercise 8

Using Facet_Wraps make a graph from the times series data for confirmed cases for all US states and territories. (Hint: Instead of the global time series use the US time series data in the same folder time_series_covid19_deaths_US.csv and time_series_covid19_confirmed_US) Format the table to look nice in the report by changing the number of rows in your graph and/or adjusting the height in the R code chunk header.

```{r}

library(tidyverse)

time_series_confirmed <- read_csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")) %>%
  select(7:length(.)) %>%
  gather(key="date", value="cases", 6:length(.)) %>%
  mutate(date = lubridate::mdy(date)) %>%
  group_by(date, Province_State) %>%
  summarize(total_cases = sum(cases))

head(time_series_confirmed)

```

```{r fig.height=6}

options(scipen=5)

library(ggplot2)

ggplot(time_series_confirmed, aes(x=date, y=total_cases)) +
  geom_line() +
  labs(x="", y="confirmed COVID-19 cases", title="Confirmed COVID-19 Cases for U.S. States and Territories") +
  facet_wrap(~Province_State, ncol=6) +
  theme_linedraw() +
  theme(plot.title=element_text(hjust=0.5, face="bold"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())

```


### Challenge Exercise 9

Apply a theme other than the one used in the Data Carpentries tutorial to the graph in Ex8.

```{r fig.height=6}

options(scipen=5)

library(ggplot2)

ggplot(time_series_confirmed, aes(x=date, y=total_cases)) +
  geom_line() +
  labs(x="", y="confirmed COVID-19 cases", title="Confirmed COVID-19 Cases for U.S. States and Territories") +
  facet_wrap(~Province_State, ncol=6) +
  theme_grey() +
  theme(plot.title=element_text(hjust=0.5, face="bold"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank())

```



